import{a as M,Q}from"./QAvatar.ff360a4e.js";import{h as $,v as T,f as j,Q as z}from"./QBtn.02cef3e0.js";import{b as O,Q as K,c as W}from"./QInput.b04191e0.js";import{l as X,t as C,a7 as Y,ad as Z,ao as G,v as N,m as H,B as J,Q as V,a2 as ee,am as te,n as A,A as D,o as b,W as q,x as p,w as B,X as S,Y as R,y as P,ar as ae,z as se,as as oe,Z as ne,ab as re,p as ie}from"./index.31f00e6e.js";import{q as U,w as ue,k as ce,j as de,e as E,m as I,l as le,h as me,f as fe}from"./firebase.21bf6f1f.js";import{u as pe,a as ve}from"./room.65373b80.js";import"./auth.b6bd1098.js";var he=X({name:"QForm",props:{autofocus:Boolean,noErrorFocus:Boolean,noResetFocus:Boolean,greedy:Boolean,onSubmit:Function},emits:["reset","validationSuccess","validationError"],setup(r,{slots:l,emit:i}){const g=J(),u=C(null);let m=0;const c=[];function v(e){const d=typeof e=="boolean"?e:r.noErrorFocus!==!0,_=++m,s=(a,n)=>{i(`validation${a===!0?"Success":"Error"}`,n)},t=a=>{const n=a.validate();return typeof n.then=="function"?n.then(f=>({valid:f,comp:a}),f=>({valid:!1,comp:a,err:f})):Promise.resolve({valid:n,comp:a})};return(r.greedy===!0?Promise.all(c.map(t)).then(a=>a.filter(n=>n.valid!==!0)):c.reduce((a,n)=>a.then(()=>t(n).then(f=>{if(f.valid===!1)return Promise.reject(f)})),Promise.resolve()).catch(a=>[a])).then(a=>{if(a===void 0||a.length===0)return _===m&&s(!0),!0;if(_===m){const{comp:n,err:f}=a[0];if(f!==void 0&&console.error(f),s(!1,n),d===!0){const F=a.find(({comp:L})=>typeof L.focus=="function"&&T(L.$)===!1);F!==void 0&&F.comp.focus()}}return!1})}function h(){m++,c.forEach(e=>{typeof e.resetValidation=="function"&&e.resetValidation()})}function y(e){e!==void 0&&V(e);const d=m+1;v().then(_=>{d===m&&_===!0&&(r.onSubmit!==void 0?i("submit",e):e!==void 0&&e.target!==void 0&&typeof e.target.submit=="function"&&e.target.submit())})}function k(e){e!==void 0&&V(e),i("reset"),ee(()=>{h(),r.autofocus===!0&&r.noResetFocus!==!0&&x()})}function x(){O(()=>{if(u.value===null)return;const e=u.value.querySelector("[autofocus][tabindex], [data-autofocus][tabindex]")||u.value.querySelector("[autofocus] [tabindex], [data-autofocus] [tabindex]")||u.value.querySelector("[autofocus], [data-autofocus]")||Array.prototype.find.call(u.value.querySelectorAll("[tabindex]"),d=>d.tabIndex!==-1);e!=null&&e.focus({preventScroll:!0})})}Y(te,{bindComponent(e){c.push(e)},unbindComponent(e){const d=c.indexOf(e);d!==-1&&c.splice(d,1)}});let w=!1;return Z(()=>{w=!0}),G(()=>{w===!0&&r.autofocus===!0&&x()}),N(()=>{r.autofocus===!0&&x()}),Object.assign(g.proxy,{validate:v,resetValidation:h,submit:y,reset:k,focus:x,getValidationComponents:()=>c}),()=>H("form",{class:"q-form",ref:u,onSubmit:y,onReset:k},$(l.default))}});const ye={class:"row items-center no-wrap q-pa-sm"},ge=["src"],xe={class:"column"},_e={class:"text-caption"},be={class:"text-body1"},qe=A({__name:"ChatMessage",props:{data:{type:Object,required:!0,default:()=>({author:{id:"",displayName:"",photoURL:""},message:"",timestamp:null})}},setup(r){const l=r,i=D(()=>l.data.message),g=D(()=>l.data.author.photoURL),u=D(()=>l.data.author.displayName);return(m,c)=>(b(),q("div",ye,[p(M,{size:"32px",class:"q-mr-md"},{default:B(()=>[S("img",{src:g.value},null,8,ge)]),_:1}),S("div",xe,[S("span",_e,R(u.value),1),S("span",be,[P(R(i.value)+" ",1),p(K,{dense:"",size:"sm",class:"q-ml-sm text-grey-7 self-center"},{default:B(()=>{var v,h,y;return[P(R(((v=l.data.timestamp)==null?void 0:v.toDate().toLocaleDateString())===new Date().toLocaleDateString()?(h=l.data.timestamp)==null?void 0:h.toDate().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):(y=l.data.timestamp)==null?void 0:y.toDate().toLocaleString([],{hour:"2-digit",minute:"2-digit"})),1)]}),_:1})])])]))}}),Se={class:"q-pa-md"},we={key:0,class:"q-pa-md"},Ce={key:1},ke={key:0,class:"text-center q-pa-md text-grey"},Pe=A({__name:"ChatPage",setup(r){var _;const i=(_=ae().params)==null?void 0:_.id,{room:g,fetchRoomData:u,updateLatestMessage:m}=pe(),{currentUser:c}=ve(),v=C([]),h=C([]),y=C(!0),k=async()=>{if(g.users.length>0){const s=U(de,ue(ce(),"in",g.users)),t=await E(s);v.value=t.docs.map(o=>({id:o.id,displayName:o.data().displayName,photoURL:o.data().photoURL,rooms:o.data().rooms}))}},x=D(()=>h.value.map(s=>{const t=s.data;return{id:s.id,data:{message:t.message,author:v.value.find(o=>o.id===t.author),timestamp:t.timestamp}}})),w=async()=>{try{const s=U(I(i),le("timestamp","desc")),t=await E(s);h.value=t.docs.map(o=>({id:o.id,data:o.data()}))}catch(s){console.error("Failed to fetch messages",s)}finally{y.value=!1}},e=C(""),d=async()=>{var s;if(!!e.value.trim())try{const t=me();await fe(I(i),{message:e.value,author:(s=c.value)==null?void 0:s.uid,timestamp:t}),await m(i,{text:e.value,timestamp:t}),e.value="",await w()}catch(t){console.error("Failed to send message:",t)}};return N(async()=>{await u(i),await Promise.all([w(),k()])}),(s,t)=>(b(),q("div",Se,[se(g).loading||y.value?(b(),q("div",we,[p(Q,{type:"text",class:"q-mb-sm"}),p(Q,{type:"text",class:"q-mb-sm"}),p(Q,{type:"text"})])):(b(),q("div",Ce,[p(he,{class:"q-mt-md",onSubmit:t[1]||(t[1]=oe(()=>{},["prevent"]))},{default:B(()=>[p(W,{modelValue:e.value,"onUpdate:modelValue":t[0]||(t[0]=o=>e.value=o),label:"Type a message",dense:"",outlined:"",class:"q-mb-md"},{after:B(()=>[p(z,{round:"",dense:"",flat:"",icon:"send",color:"pink-5",type:"submit",onClick:d})]),_:1},8,["modelValue"])]),_:1}),x.value.length===0?(b(),q("div",ke,[p(j,{name:"chat",size:"48px",color:"grey-4"}),t[2]||(t[2]=S("div",{class:"text-h6 q-mt-sm"},"No messages yet",-1)),t[3]||(t[3]=S("div",{class:"text-caption"},"Be the first to start the conversation!",-1))])):(b(!0),q(ne,{key:1},re(x.value,o=>(b(),ie(qe,{key:o.id,data:o.data},null,8,["data"]))),128))]))]))}});export{Pe as default};
