import{T as x,d as n,c as m,g as l,u as i,j as p,q as T,w as j,k as q,e as L,i as v}from"./firebase.21bf6f1f.js";import{u as C}from"./auth.b6bd1098.js";import{t as M,a9 as F}from"./index.31f00e6e.js";const y=M(null);function R(){const{user:t}=C();return y.value=t.value,{currentUser:y}}function B(){const t=F({loading:!0,name:"",users:[],latestMessage:{text:"",timestamp:x.now()}}),g=M([]),{currentUser:d}=R(),U=async a=>{var s,e;if(!!d.value)try{const o=n(m,a),u=((s=(await l(o)).data())==null?void 0:s.users)||[];await i(o,{users:u.filter(f=>{var w;return f!==((w=d.value)==null?void 0:w.uid)})});const r=n(p,d.value.uid),D=((e=(await l(r)).data())==null?void 0:e.rooms)||[];await i(r,{rooms:D.filter(f=>f!==a)})}catch(o){console.error("Failed to leave room:",o)}},h=async a=>{await l(n(m,a)).then(async s=>{const e=s.data();if(t.name=e==null?void 0:e.name,t.users=e==null?void 0:e.users,t.latestMessage.text=e==null?void 0:e.latestMessageText,t.latestMessage.timestamp=e==null?void 0:e.latestMessageTimestamp,t.users.length>0){const o=T(p,j(q(),"in",t.users)),c=await L(o);g.value=c.docs.map(u=>{const r=u.data();return{id:u.id,displayName:r.displayName,photoURL:r.photoURL,rooms:r.rooms}})}t.loading=!1}).catch(s=>{console.error("failed to fetch room data",s),t.loading=!1})};return{room:t,chatUsers:g,fetchRoomData:h,updateLatestMessage:async(a,s)=>{try{await i(n(m,a),{latestMessageText:s.text,latestMessageTimestamp:s.timestamp})}catch(e){console.error("Failed to update latest message:",e)}},joinRoom:async a=>{const{currentUser:s}=R();if(!!s.value)try{const e=n(m,a),o=n(p,s.value.uid),c=await l(e);if(!c.exists())return;c.data().users.includes(s.value.uid)||(await i(e,{users:v(s.value.uid)}),await i(o,{rooms:v(a)}),await h(a))}catch(e){console.error("Failed to join room:",e)}},leaveRoom:U}}export{R as a,B as u};
